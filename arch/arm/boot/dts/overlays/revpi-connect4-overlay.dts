// SPDX-License-Identifier: GPL-2.0-only
/dts-v1/;
/plugin/;
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/bcm2835.h>

/ {
	compatible = "brcm,bcm2711";

	fragment@0 {
		target-path = "/";
		__overlay__ {
			compatible = "kunbus,revpi-connect4", "brcm,bcm2711";
		};
	};

	/* PINMUX */
	fragment@1 {
		target = <&gpio>;
		__overlay__ {
			i2c3_pins: i2c3_pins {
				/* SDA, SCL */
				brcm,pins     = <2 3>;
				brcm,function = <BCM2835_FSEL_ALT5>;
			};
			exp_core_pins: exp_core_pins {
				brcm,pins     = <8>;
				brcm,function = <BCM2835_FSEL_GPIO_IN>;
				brcm,pull     = <BCM2835_PUD_OFF>;
			};
			exp_power_pins: exp_power_pins {
				brcm,pins     = <9>;
				brcm,function = <BCM2835_FSEL_GPIO_IN>;
				brcm,pull     = <BCM2835_PUD_OFF>;
			};
			i2c6_pins: i2c6_pins {
				/* SDA (ID_SD), SCL (ID_SC)*/
				brcm,pins     = <0 1>;
				brcm,function = <BCM2835_FSEL_ALT5>;
			};
			spi6_pins: spi6_pins {
				/* MISO, MOSI, SCLK */
				brcm,pins     = <19 20 21>;
				brcm,function = <BCM2835_FSEL_ALT3>;
			};
			spi6_cs_pins: spi6_cs_pins {
				/* ksz9897 */
				brcm,pins     = <16>;
				brcm,function = <BCM2835_FSEL_GPIO_OUT>;
			};
		};
	};

	/* I2C3 */
	fragment@2 {
		target = <&i2c3>;
		__overlay__ {
			#address-cells = <1>;
			#size-cells = <0>;
			pinctrl-names = "default";
			pinctrl-0 = <&i2c3_pins>;
			clock-frequency = <400000>;
			status = "okay";

			expander_power: gpio@21 {
				/* 100kHz, 400kHz */
				compatible = "nxp,pcal6416";
				pinctrl-names = "default";
				pinctrl-0 = <&exp_power_pins>;
				reg = <0x21>;
				gpio-controller;
				#gpio-cells = <2>;
				status = "okay";
				interrupt-controller;
				#interrupt-cells = <2>;
				interrupt-parent = <&gpio>;
				interrupts = <9 IRQ_TYPE_LEVEL_LOW>;
			};

			expander_core: gpio@22 {
				/* 100kHz, 400kHz */
				compatible = "nxp,pcal6524";
				pinctrl-names = "default";
				pinctrl-0 = <&exp_core_pins>;
				reg = <0x22>;
				gpio-controller;
				#gpio-cells = <2>;
				status = "okay";
				interrupt-controller;
				#interrupt-cells = <2>;
				interrupt-parent = <&gpio>;
				interrupts = <8 IRQ_TYPE_LEVEL_LOW>;
			};

			rtc@51 {
				/* 100kHz, 400kHz */
				compatible = "nxp,pcf2129";
				reg = <0x51>;
				status = "okay";
				reset-source;
			};
		};
	};

	/* I2C6 */
	fragment@3 {
		target = <&i2c6>;
		__overlay__ {
			#address-cells = <1>;
			#size-cells = <0>;
			pinctrl-names = "default";
			pinctrl-0 = <&i2c6_pins>;
			clock-frequency = <400000>;
			status = "okay";

			eeprom: eeprom@50 {
				/* 100kHz, 400kHz or 1MHz */
				compatible = "atmel,24c256";
				reg = <0x50>;
				pagesize = <64>;
				status = "okay";
			};
		};
	};

	/* SPI6 */
	fragment@4 {
		target = <&spi6>;
		__overlay__ {
			#address-cells = <1>;
			#size-cells = <0>;
			pinctrl-names = "default";
			pinctrl-0 = <&spi6_pins>, <&spi6_cs_pins>;
			cs-gpios = <&gpio 16 GPIO_ACTIVE_LOW>;
			status = "okay";

			ksz9897: ksz9897@0 {
				compatible = "microchip,ksz9897";
				reg = <0>;
				spi-max-frequency = <25000000>;
				spi-cpha;
				spi-cpol;
				reset-gpios = <&expander_core 20 GPIO_ACTIVE_LOW>;
				status = "okay";

				ports {
					#address-cells = <1>;
					#size-cells = <0>;
					/* PORT 1 */
					port@0 {
						reg = <0>;
						label = "eth0";
					};
					/* PORT 2 */
					port@1 {
						reg = <1>;
						label = "eth1";
					};
					/* PORT 3 */
					port@2 {
						reg = <2>;
						label = "cpu";
						ethernet = <&genet>;
					};
					/* PORT 4 */
					port@3 {
						reg = <3>;
						label = "piright";
					};
					/* PORT 5 */
					port@4 {
						reg = <4>;
						label = "pileft";
					};
					/*
					 * PORT 6, 7 are unused
					 */
				};
			};
		};
	};
};
