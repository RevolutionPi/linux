// SPDX-License-Identifier: GPL-2.0
// SPDX-FileCopyrightText: Copyright 2024 KUNBUS GmbH

#include "revpi-connect5-can-overlay.dts"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/interrupt-controller/irq.h>

/ {
	compatible = "brcm,bcm2712";

	fragment@0 {
		target-path = "/";
		__overlay__ {
			compatible = "kunbus,revpi-connect5-can-can",
				     "kunbus,revpi-connect5", "brcm,bcm2712";
		};
	};

	fragment@1 {
		target = <&gpio>;
		__overlay__ {
			gpio-line-names =
				"ID_SDA", // GPIO0
				"ID_SCL", // GPIO1
				"I2C1_SDA", // GPIO2
				"I2C1_SCL", // GPIO3
				"UART2_TX", // GPIO4
				"UART2_RX", // GPIO5
				"INT_CAN0", // GPIO6
				"UART2_RTS", // GPIO7
				"INT_IOEX_CORE", // GPIO8
				"INT_IOX_POWER", // GPIO9
				"INT_TPM", // GPIO10
				"SPI1_CS1", // GPIO11
				"SPI5_CS1", // GPIO12
				"SPI5_MISO", // GPIO13
				"SPI5_MOSI", // GPIO14
				"SPI5_CLK", // GPIO15
				"-", // GPIO16
				"ID_WP", // GPIO17
				"SPI1_CS0", // GPIO18
				"SPI1_MISO", // GPIO19
				"SPI1_MOSI", // GPIO20
				"SPI1_CLK", // GPIO21
				"-", // GPIO22
				"-", // GPIO23
				"-", // GPIO24
				"INT_CAN1", // GPIO25
				"-", // GPIO26
				"-", // GPIO27

				"PCIE_PWR_EN", // GPIO28
				"FAN_TACH", // GPIO29
				"HOST_SDA", // GPIO30
				"HOST_SCL", // GPIO31
				"ETH_RST_N", // GPIO32
				"PCIE_DET_WAKE", // GPIO33

				"CD0_IO0_MICCLK", // GPIO34
				"CD0_IO0_MICDAT0", // GPIO35
				"RP1_PCIE_CLKREQ_N", // GPIO36
				"ETH_IRQ_N", // GPIO37
				"SDA0", // GPIO38
				"SCL0", // GPIO39
				"-", // GPIO40
				"-", // GPIO41
				"USB_VBUS_EN", // GPIO42
				"USB_OC_N", // GPIO43
				"RP1_STAT_LED", // GPIO44
				"FAN_PWM", // GPIO45
				"-", // GPIO46
				"2712_WAKE", // GPIO47
				"-", // GPIO48
				"-", // GPIO49
				"-", // GPIO50
				"-", // GPIO51
				"-", // GPIO52
				"-"; // GPIO53

			can1_pins: can1_pins {
				/* IRQ */
				function = "gpio";
				pins = "gpio25";
				bias-disable;
			};

			con5_spi5_pins: con5_spi5_pins {
				/* MISO, MOSI, CLK */
				function = "spi5";
				pins = "gpio13", "gpio14", "gpio15";
				bias-disable;
			};

			con5_spi5_cs_pins: con5_spi5_cs_pins {
				/* CE0 (CAN1) */
				function = "gpio";
				pins = "gpio12";
				bias-disable;
			};
		};
	};


	fragment@2 {
		target = <&i2c1>;
		__overlay__ {
			exp_gpio_power: gpio@21 {
				gpio-line-names =
					"LED_A3_RD", // GPIO0 / P0_0
					"LED_A3_GN", // GPIO1 / P0_1
					"LED_A3_BL", // GPIO2 / P0_2
					"PB_R_MPX_S", // GPIO3 / P0_3
					"CAN1_TERM", // GPIO4 / P0_4
					"PB_R_DETECT", // GPIO5 / P0_5
					"PB_R_ETH_RST", // GPIO6 / P0_6
					"CAN1_STBY", // GPIO7 / P0_7
					"LED_A4_RD", // GPIO8 / P1_0
					"LED_A4_GN", // GPIO9 / P1_1
					"LED_A4_BL", // GPIO10 / P1_2
					"LED_A5_RD", // GPIO11 / P1_3
					"LED_A5_GN", // GPIO12 / P1_4
					"LED_A5_BL", // GPIO13 / P1_5
					"PB_R_SNIFF", // GPIO14 / P1_6
					"PB_R_ACK"; // GPIO15 / P1_7
			};
		};
	};

	/* UART4 */
	fragment@6 {
		target = <&uart4>;
		__overlay__ {
			status = "disabled";
		};
	};

	/* SPI5 */
	fragment@200 {
		target = <&spi5>;
		__overlay__ {
			pinctrl-names = "default";
			pinctrl-0 = <&con5_spi5_pins>, <&con5_spi5_cs_pins>;
			cs-gpios = <&gpio 12 GPIO_ACTIVE_LOW>;
			status = "okay";

			can1: can@0 {
				compatible = "microchip,mcp251863";
				pinctrl-names = "default";
				pinctrl-0 = <&can1_pins>;
				reg = <0>;
				clocks = <&can_20mhz_osc>;
				/*
				   FSCK must be less than or equal to 0.85*(FSYSCLK/2)
				   0.85 * (20MHz / 2) = 8.5MHz
				*/
				spi-max-frequency = <8500000>;
				interrupts-extended = <&gpio 25 IRQ_TYPE_LEVEL_LOW>;
				termination-gpios = <&exp_gpio_power 4 GPIO_ACTIVE_HIGH>;
				termination-ohms = <120>;
			};
		};
	};
};
